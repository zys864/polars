<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Performance"><meta name="keywords" content="rust, rustlang, rust-lang, performance"><title>polars::docs::performance - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script src="../../../crates.js"></script><script defer src="../../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a class="sidebar-logo" href="../../../polars/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.png" alt="logo"></div>
        </a><h2 class="location">Module performance</h2><div class="sidebar-elems"><div id="sidebar-vars" data-name="performance" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../polars/index.html"><img class="rust-logo" src="../../../rust-logo.png" alt="logo"></a><nav class="sub"><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><h1 class="fqn"><span class="in-band">Module <a href="../../index.html">polars</a>::<wbr><a href="../index.html">docs</a>::<wbr><a class="mod" href="#">performance</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../../../src/polars/docs/performance.rs.html#1-92" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h2 id="performance" class="section-header"><a href="#performance">Performance</a></h2>
<p>Understanding the memory format used by Arrow/ Polars can really increase performance of your
queries. This is especially true for large string data. The figure below shows how an Arrow UTF8
array is laid out in memory.</p>
<p>The array <code>[&quot;foo&quot;, &quot;bar&quot;, &quot;ham&quot;]</code> is encoded by</p>
<ul>
<li>a concatenated string <code>&quot;foobarham&quot;</code></li>
<li>an offset array indicating the start (and end) of each string <code>[0, 2, 5, 8]</code></li>
<li>a null bitmap, indicating null values</li>
</ul>
<p><img src="https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/arrow-string.svg" alt="" /></p>
<p>This memory structure is very cache efficient if we are to read the string values. Especially if
we compare it to a <code>Vec&lt;String&gt;</code>.</p>
<p><img src="https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/pandas-string.svg" alt="" /></p>
<p>However, if we need to reorder the Arrow UTF8 array, we need to swap around all the bytes of the
string values, which can become very expensive when we’re dealing with large strings. On the
other hand, for the <code>Vec&lt;String&gt;</code>, we only need to swap pointers around which is only 8 bytes data
that have to be moved.</p>
<p>If you have a <a href="../../frame/struct.DataFrame.html">DataFrame</a> with a large number of
<a href="../../datatypes/type.Utf8Chunked.html">Utf8Chunked</a> columns and you need to reorder them due to an
operation like a FILTER, JOIN, GROUPBY, etc. than this can become quite expensive.</p>
<h3 id="categorical-type" class="section-header"><a href="#categorical-type">Categorical type</a></h3>
<p>For this reason Polars has a <a href="https://pola-rs.github.io/polars/polars/datatypes/struct.CategoricalType.html">CategoricalType</a>.
A <code>CategoricalChunked</code> is an array filled with <code>u32</code> values that each represent a unique string value.
Thereby maintaining cache-efficiency, whilst also making it cheap to move values around.</p>
<h4 id="example-single-dataframe" class="section-header"><a href="#example-single-dataframe">Example: Single DataFrame</a></h4>
<p>In the example below we show how you can cast a <code>Utf8Chunked</code> column to a <code>CategoricalChunked</code>.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">polars::prelude</span>::<span class="kw-2">*</span>;

<span class="kw">fn</span> <span class="ident">example</span>(<span class="ident">path</span>: <span class="kw-2">&amp;</span><span class="ident">str</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">DataFrame</span><span class="op">&gt;</span> {
    <span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">df</span> <span class="op">=</span> <span class="ident">CsvReader::from_path</span>(<span class="ident">path</span>)<span class="question-mark">?</span>
                .<span class="ident">finish</span>()<span class="question-mark">?</span>;

    <span class="ident">df</span>.<span class="ident">try_apply</span>(<span class="string">&quot;utf8-column&quot;</span>, <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">cast</span>::<span class="op">&lt;</span><span class="ident">CategoricalType</span><span class="op">&gt;</span>())<span class="question-mark">?</span>;
    <span class="prelude-val">Ok</span>(<span class="ident">df</span>)
}
</code></pre></div>
<h4 id="example-eager-join-multiple-dataframes-on-a-categorical" class="section-header"><a href="#example-eager-join-multiple-dataframes-on-a-categorical">Example: Eager join multiple DataFrames on a Categorical</a></h4>
<p>When the strings of one column need to be joined with the string data from another <code>DataFrame</code>.
The <code>Categorical</code> data needs to be synchronized (Categories in df A need to point to the same
underlying string data as Categories in df B). You can do that by turning the global string cache
on.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">polars::prelude</span>::<span class="kw-2">*</span>;
<span class="kw">use</span> <span class="ident">polars::toggle_string_cache</span>;

<span class="kw">fn</span> <span class="ident">example</span>(<span class="kw-2">mut</span> <span class="ident">df_a</span>: <span class="ident">DataFrame</span>, <span class="kw-2">mut</span> <span class="ident">df_b</span>: <span class="ident">DataFrame</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">DataFrame</span><span class="op">&gt;</span> {
    <span class="comment">// Set a global string cache</span>
    <span class="ident">toggle_string_cache</span>(<span class="bool-val">true</span>);

    <span class="ident">df_a</span>.<span class="ident">try_apply</span>(<span class="string">&quot;a&quot;</span>, <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">cast</span>::<span class="op">&lt;</span><span class="ident">CategoricalType</span><span class="op">&gt;</span>())<span class="question-mark">?</span>;
    <span class="ident">df_b</span>.<span class="ident">try_apply</span>(<span class="string">&quot;b&quot;</span>, <span class="op">|</span><span class="ident">s</span><span class="op">|</span> <span class="ident">s</span>.<span class="ident">cast</span>::<span class="op">&lt;</span><span class="ident">CategoricalType</span><span class="op">&gt;</span>())<span class="question-mark">?</span>;
    <span class="ident">df_a</span>.<span class="ident">join</span>(<span class="kw-2">&amp;</span><span class="ident">df_b</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="ident">JoinType::Inner</span>)
}</code></pre></div>
<h4 id="example-lazy-join-multiple-dataframes-on-a-categorical" class="section-header"><a href="#example-lazy-join-multiple-dataframes-on-a-categorical">Example: Lazy join multiple DataFrames on a Categorical</a></h4>
<p>A lazy Query always has a global string cache (unless you opt-out) for the duration of that query (until <code>collect</code> is called).
The example below shows how you could join two DataFrames with Categorical types.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">polars::prelude</span>::<span class="kw-2">*</span>;

<span class="kw">fn</span> <span class="ident">lazy_example</span>(<span class="kw-2">mut</span> <span class="ident">df_a</span>: <span class="ident">LazyFrame</span>, <span class="kw-2">mut</span> <span class="ident">df_b</span>: <span class="ident">LazyFrame</span>) -&gt; <span class="prelude-ty">Result</span><span class="op">&lt;</span><span class="ident">DataFrame</span><span class="op">&gt;</span> {

    <span class="kw">let</span> <span class="ident">q1</span> <span class="op">=</span> <span class="ident">df_a</span>.<span class="ident">with_columns</span>(<span class="macro">vec!</span>[
        <span class="ident">col</span>(<span class="string">&quot;a&quot;</span>).<span class="ident">cast</span>(<span class="ident">DataType::Categorical</span>),
    ]);

    <span class="kw">let</span> <span class="ident">q2</span> <span class="op">=</span> <span class="ident">df_b</span>.<span class="ident">with_columns</span>(<span class="macro">vec!</span>[
        <span class="ident">col</span>(<span class="string">&quot;b&quot;</span>).<span class="ident">cast</span>(<span class="ident">DataType::Categorical</span>)
    ]);
    <span class="ident">q1</span>.<span class="ident">inner_join</span>(<span class="ident">q2</span>, <span class="ident">col</span>(<span class="string">&quot;a&quot;</span>), <span class="ident">col</span>(<span class="string">&quot;b&quot;</span>), <span class="prelude-val">None</span>).<span class="ident">collect</span>()
}</code></pre></div>
</div></details></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="polars" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.59.0-nightly (cfa3fe5af 2021-12-31)" ></div>
</body></html>